# Dignity

A CLI tool for displaying Claude Code token metrics in your status line.

## Installation

```bash
uv pip install -e .
```

## Usage

```bash
dignity <path_to_transcript.jsonl>
```

The CLI reads a Claude Code transcript file (in JSONL format) and outputs token usage metrics suitable for display in a status line:

```
In: 3.5K | Out: 1.8K | Cache: 12.5K | Total: 17.8K | Ctx: 9.5K
```

### Metrics Explained

- In: Input tokens (tokens sent to Claude)
- Out: Output tokens (tokens generated by Claude)
- Cache: Cached tokens (cache reads + cache creation)
- Total: Total tokens used (input + output + cache)
- Ctx: Context length (tokens in the most recent message)

### Integration with Status Lines

You can integrate this with your shell's status line (e.g., in your `.bashrc`, `.zshrc`, or tmux configuration):

```bash
# Example for bash/zsh prompt
export PS1='$(dignity ~/.claude/transcript.jsonl) $ '
```

## Hook Dispatch

Declarative rule-based activation system for Claude Code hooks.

### CLI

```bash
# Process hook event from stdin JSON
echo '{"prompt": "implement feature X"}' | dignity dispatch UserPromptSubmit
```

### Shell Hook Integration

Add to `~/.claude/settings.json`:

```json
{
  "hooks": {
    "UserPromptSubmit": [
      {
        "type": "command",
        "command": "dignity dispatch UserPromptSubmit"
      }
    ]
  }
}
```

### Configuration

Rules are loaded from (first found wins):

1. `DIGNITY_RULES_PATH` environment variable
2. `.claude/rules.json` (project-local)
3. `~/.claude/hooks/rules.json` (global)

### Rules Format

```json
{
  "rules": {
    "suggest-tdd": {
      "priority": "high",
      "action": {
        "type": "suggest_skill",
        "skill": "code-test",
        "reason": "Implementation task detected"
      },
      "triggers": {
        "UserPromptSubmit": {
          "keywords": ["implement", "add", "create"]
        }
      }
    }
  }
}
```

### Action Types

| Type | Fields | Description |
|------|--------|-------------|
| `suggest_skill` | `skill`, `reason` | Suggest invoking a skill |
| `remind` | `message` | Show reminder in output |
| `block` | `reason` | Block with error (SubagentStop) |
| `inject_context` | `context` | Add context to prompt |

### Trigger Types

| Trigger | Fields | Hook Events |
|---------|--------|-------------|
| `keywords` | Word list | UserPromptSubmit |
| `intent_patterns` | Regex list | UserPromptSubmit |
| `tool_result` | `tool_name`, `parameter_patterns` | Stop |
| `todo_state` | `any_completed`, `all_completed` | Stop |
| `skill_invoked` | `skill` | Stop |
| `output_missing` | `required_patterns` | SubagentStop |

## Development

### Running Tests

```bash
uv run pytest tests/
```

### Features

- Handles invalid JSON lines gracefully
- Excludes sidechain messages from context calculation
- Excludes API error messages from context calculation
- Returns zero metrics for nonexistent files
- Uses most recent timestamped message for context length
